<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema de Tickets - O de Quadro</title>
    <meta name="description" content="Sistema interno para abertura e acompanhamento de tickets entre colaboradores, departamento pessoal e gestores." />
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="header-top-bar">
        <div class="container">
          <div class="header-logo">
            <a href="index.html">
              <img src="Logo Grupo O. de Quadro.png" alt="O de Quadro - Grupo" />
            </a>
          </div>
        </div>
      </div>
      <nav class="main-nav">
        <div class="container">
          <ul class="nav-links">
            <li><a href="index.html">Início</a></li>
            <li><a href="solucoes.html">Soluções</a></li>
            <li><a href="segmentos.html">Segmentos</a></li>
            <li><a href="incorporadora.html">Incorporadora</a></li>
            <li><a href="certificacoes.html">Certificações</a></li>
            <li><a href="noticias.html">Notícias</a></li>
            <li><a href="faq.html">FAQ</a></li>
            <li><a href="contato.html">Contato</a></li>
          </ul>
          <button class="nav-toggle" aria-expanded="false">
            <span class="hamburger"></span>
            Menu
          </button>
        </div>
      </nav>
    </header>

    <main>
      <!-- Hero Section -->
      <section class="page-hero ticket-hero">
        <div class="container">
          <div class="hero-breadcrumb">
            <a href="index.html">Início</a>
            <span>/</span>
            <a href="faq.html">FAQ</a>
            <span>/</span>
            <span>Sistema de Tickets</span>
          </div>
          <h1>Sistema de Tickets Interno</h1>
          <p>Abra e acompanhe solicitações ao Departamento Pessoal e Gestores</p>
        </div>
      </section>

      <!-- Login Section -->
      <section class="ticket-login" id="loginSection">
        <div class="container">
          <div class="login-container">
            <div class="login-card">
              <div class="login-header">
                <h2>Acesso ao Sistema</h2>
                <p>Faça login para abrir ou acompanhar tickets</p>
              </div>
              
              <div class="login-tabs">
                <button class="tab-btn active" data-tab="colaborador">
                  <i class="fas fa-user"></i>
                  Colaborador
                </button>
                <button class="tab-btn" data-tab="gestor">
                  <i class="fas fa-user-tie"></i>
                  Gestor
                </button>
                <button class="tab-btn" data-tab="dp">
                  <i class="fas fa-users-cog"></i>
                  Depto. Pessoal
                </button>
                <button class="tab-btn primeiro-acesso" data-tab="primeiro-acesso">
                  <i class="fas fa-user-plus"></i>
                  Primeiro Acesso
                </button>
              </div>

              <!-- Formulário de Login -->
              <form class="login-form" id="loginForm">
                <div class="form-group">
                  <label for="cpf">CPF</label>
                  <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" maxlength="14" pattern="[0-9]{3}\.[0-9]{3}\.[0-9]{3}-[0-9]{2}|[0-9]{11}" required>
                </div>
                
                <div class="form-group">
                  <label for="senha">Senha</label>
                  <input type="password" id="senha" name="senha" placeholder="Digite sua senha" maxlength="50" minlength="4" required>
                </div>

                <button type="submit" class="login-btn">
                  <i class="fas fa-sign-in-alt"></i>
                  Entrar no Sistema
                </button>
              </form>
              
              <!-- Formulário de Primeiro Acesso -->
              <form class="primeiro-acesso-form form-hidden" id="primeiroAcessoForm">
                <div class="form-group">
                  <label for="primeiroCPF">CPF</label>
                  <input type="text" id="primeiroCPF" name="cpf" placeholder="000.000.000-00" maxlength="14" pattern="[0-9]{3}\.[0-9]{3}\.[0-9]{3}-[0-9]{2}|[0-9]{11}" required>
                </div>
                
                <div class="form-group">
                  <label for="primeiroNome">Nome Completo</label>
                  <input type="text" id="primeiroNome" name="nome" placeholder="Digite seu nome completo" maxlength="100" minlength="2" required>
                </div>
                
                <div class="form-group">
                  <label for="primeiroEmail">E-mail</label>
                  <input type="email" id="primeiroEmail" name="email" placeholder="seu@email.com" maxlength="100" required>
                </div>
                
                <div class="form-group">
                  <label for="primeiroSetor">Setor</label>
                  <select id="primeiroSetor" name="setor" required>
                    <option value="">Selecione seu setor</option>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Financeiro">Financeiro</option>
                    <option value="Comercial">Comercial</option>
                    <option value="Operacional">Operacional</option>
                    <option value="Jurídico">Jurídico</option>
                    <option value="Recursos Humanos">Recursos Humanos</option>
                    <option value="TI">TI</option>
                    <option value="Outros">Outros</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="primeiroTipo">Tipo de Usuário</label>
                  <select id="primeiroTipo" name="role" required>
                    <option value="">Selecione seu tipo</option>
                    <option value="colaborador">Colaborador</option>
                    <option value="gestor">Gestor</option>
                  </select>
                </div>
                
                <div class="form-group form-hidden" id="contratosGroup">
                  <label for="primeiroContratos">Contrato(s) que Gerencia</label>
                  <select id="primeiroContratos" name="contratos" multiple size="8">
                    <option value="ADM CAMP">ADM CAMP</option>
                    <option value="ESUP">ESUP</option>
                    <option value="FURP">FURP</option>
                    <option value="METRÔ FIS">METRÔ FIS</option>
                    <option value="METRÔ JABA">METRÔ JABA</option>
                    <option value="P80">P80</option>
                    <option value="REPLAN">REPLAN</option>
                    <option value="REVAP">REVAP</option>
                    <option value="TJSP">TJSP</option>
                    <option value="TRANSP JURI">TRANSP JURI</option>
                    <option value="TRANSP LOG">TRANSP LOG</option>
                    <option value="UNESP INTERIOR">UNESP INTERIOR</option>
                    <option value="ESCRITÓRIO CENTRAL">ESCRITÓRIO CENTRAL</option>
                    <option value="REPLAN CAMPINAS">REPLAN CAMPINAS</option>
                    <option value="P-80">P-80</option>
                    <option value="METRÔ (ANÁLISE)">METRÔ (ANÁLISE)</option>
                    <option value="TJ - MOTORISTAS">TJ - MOTORISTAS</option>
                    <option value="METRÔ ECONÔMICO">METRÔ ECONÔMICO</option>
                    <option value="ENGENHARIA SS">ENGENHARIA SS</option>
                    <option value="TRANSPETRO LOGISTICA">TRANSPETRO LOGISTICA</option>
                  </select>
                  <small class="helper-text">
                    Segure Ctrl (Windows) ou Cmd (Mac) para selecionar múltiplos contratos
                  </small>
                </div>
                
                <div class="form-group">
                  <label for="primeiroSenha">Nova Senha</label>
                  <input type="password" id="primeiroSenha" name="senha" placeholder="Mínimo 6 caracteres" maxlength="50" minlength="6" required>
                </div>
                
                <div class="form-group">
                  <label for="primeiroConfirmSenha">Confirmar Senha</label>
                  <input type="password" id="primeiroConfirmSenha" name="confirmSenha" placeholder="Confirme sua senha" maxlength="50" minlength="6" required>
                </div>

                <button type="submit" class="login-btn">
                  <i class="fas fa-user-plus"></i>
                  Completar Cadastro
                </button>
              </form>

              <div class="login-help">
                <div class="help-login">
                  <p><strong>Primeira vez?</strong> Use a aba "Primeiro Acesso" para se cadastrar.</p>
                  <p><strong>Esqueceu a senha?</strong> <a href="#" onclick="showPasswordReset()">Clique aqui para redefinir</a></p>
                </div>
                <div class="help-primeiro-acesso form-hidden">
                  <p><strong>Novo no sistema?</strong> Preencha todos os dados para criar sua conta.</p>
                  <p><strong>Já tem cadastro?</strong> Use uma das outras abas para fazer login.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Password Reset Section (Hidden initially) -->
      <section class="ticket-reset dashboard-hidden" id="resetSection">
        <div class="container">
          <div class="reset-container">
            <div class="reset-card">
              <div class="reset-header">
                <h2>Redefinir Senha</h2>
                <p>Digite seu CPF e responda às perguntas de segurança</p>
              </div>
              
              <form class="reset-form" id="resetForm">
                <div class="form-group">
                  <label for="resetCPF">CPF</label>
                  <input type="text" id="resetCPF" name="cpf" placeholder="000.000.000-00" maxlength="14" pattern="[0-9]{3}\.[0-9]{3}\.[0-9]{3}-[0-9]{2}|[0-9]{11}" required>
                </div>
                
                <div class="form-group">
                  <label for="resetRole">Tipo de Usuário</label>
                  <select id="resetRole" name="role" required>
                    <option value="">Selecione seu tipo</option>
                    <option value="colaborador">Colaborador</option>
                    <option value="gestor">Gestor</option>
                    <option value="dp">Departamento Pessoal</option>
                  </select>
                </div>

                <button type="submit" class="reset-btn">
                  <i class="fas fa-search"></i>
                  Verificar Dados
                </button>
              </form>

              <div class="reset-help">
                <p><a href="#" onclick="backToLogin()">← Voltar ao Login</a></p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Password Reset Verification Section (Hidden initially) -->
      <section class="ticket-reset dashboard-hidden" id="resetVerificationSection">
        <div class="container">
          <div class="reset-container">
            <div class="reset-card">
              <div class="reset-header">
                <h2>Verificação de Segurança</h2>
                <p>Confirme seus dados para redefinir a senha</p>
              </div>
              
              <div class="verification-info" id="verificationInfo">
                <!-- Dados do usuário serão preenchidos aqui -->
              </div>
              
              <form class="verification-form" id="verificationForm">
                <div class="form-group">
                  <label for="newPassword">Nova Senha</label>
                  <input type="password" id="newPassword" name="newPassword" placeholder="Mínimo 6 caracteres" maxlength="50" minlength="6" required>
                </div>
                
                <div class="form-group">
                  <label for="confirmNewPassword">Confirmar Nova Senha</label>
                  <input type="password" id="confirmNewPassword" name="confirmNewPassword" maxlength="50" minlength="6" required>
                </div>

                <button type="submit" class="reset-btn">
                  <i class="fas fa-key"></i>
                  Redefinir Senha
                </button>
              </form>

              <div class="reset-help">
                <p><a href="#" onclick="backToLogin()">← Voltar ao Login</a></p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Register Section (Hidden initially) -->
      <section class="ticket-register dashboard-hidden" id="registerSection">
        <div class="container">
          <div class="register-container">
            <div class="register-card">
              <div class="register-header">
                <h2>Primeiro Acesso - Cadastro</h2>
                <p>Complete seus dados para acessar o sistema</p>
              </div>
              
              <form class="register-form" id="registerForm">
                <div class="form-group">
                  <label for="regNome">Nome Completo</label>
                  <input type="text" id="regNome" name="nome" maxlength="100" minlength="2" placeholder="Digite seu nome completo" required>
                </div>
                
                <div class="form-group">
                  <label for="regEmail">E-mail</label>
                  <input type="email" id="regEmail" name="email" maxlength="100" placeholder="seu@email.com" required>
                </div>
                
                <div class="form-group">
                  <label for="regSetor">Setor</label>
                  <select id="regSetor" name="setor" required>
                    <option value="">Selecione seu setor</option>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Financeiro">Financeiro</option>
                    <option value="Comercial">Comercial</option>
                    <option value="Operacional">Operacional</option>
                    <option value="Jurídico">Jurídico</option>
                    <option value="Recursos Humanos">Recursos Humanos</option>
                    <option value="TI">TI</option>
                    <option value="Outros">Outros</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="regSenha">Nova Senha</label>
                  <input type="password" id="regSenha" name="senha" placeholder="Mínimo 6 caracteres" maxlength="50" minlength="6" required>
                </div>
                
                <div class="form-group">
                  <label for="regConfirmSenha">Confirmar Senha</label>
                  <input type="password" id="regConfirmSenha" name="confirmSenha" maxlength="50" minlength="6" placeholder="Confirme sua senha" required>
                </div>

                <button type="submit" class="register-btn">
                  <i class="fas fa-user-plus"></i>
                  Completar Cadastro
                </button>
              </form>

              <div class="register-help">
                <p><strong>Dúvidas?</strong> Procure o Departamento Pessoal para assistência.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Dashboard Section (Hidden initially) -->
      <section class="ticket-dashboard dashboard-hidden" id="dashboardSection">
        <div class="container">
          
          <!-- Dashboard Header -->
          <div class="dashboard-header">
            <div class="user-info">
              <div class="user-avatar">
                <i class="fas fa-user-circle"></i>
              </div>
              <div class="user-details">
                <h3 id="userName">Usuário</h3>
                <span id="userRole" class="user-role">Colaborador</span>
              </div>
            </div>
            <button class="logout-btn" onclick="logout()">
              <i class="fas fa-sign-out-alt"></i>
              Sair
            </button>
          </div>

          <!-- Dashboard Stats -->
          <div class="dashboard-stats" id="dashboardStats">
            <div class="stat-card">
              <div class="stat-icon aberto">
                <i class="fas fa-inbox"></i>
              </div>
              <div class="stat-content">
                <h3 id="statsAbertos">0</h3>
                <p>Tickets Abertos</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon em-andamento">
                <i class="fas fa-cogs"></i>
              </div>
              <div class="stat-content">
                <h3 id="statsAndamento">0</h3>
                <p>Em Andamento</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon resolvido">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="stat-content">
                <h3 id="statsResolvidos">0</h3>
                <p>Resolvidos</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon total">
                <i class="fas fa-chart-bar"></i>
              </div>
              <div class="stat-content">
                <h3 id="statsTotal">0</h3>
                <p>Total Geral</p>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button class="action-btn primary" onclick="openNewTicketModal()">
              <i class="fas fa-plus"></i>
              Novo Ticket
            </button>
            <button class="action-btn" onclick="refreshTickets()">
              <i class="fas fa-sync-alt"></i>
              Atualizar
            </button>
            <button class="action-btn secondary export-hidden" onclick="exportTickets()" id="exportBtn">
              <i class="fas fa-download"></i>
              Exportar
            </button>
          </div>

          <!-- Tickets Filter -->
          <div class="tickets-filter">
            <div class="filter-tabs">
              <button class="filter-btn active" data-filter="all">Todos</button>
              <button class="filter-btn" data-filter="aberto">Abertos</button>
              <button class="filter-btn" data-filter="em-andamento">Em Andamento</button>
              <button class="filter-btn" data-filter="resolvido">Resolvidos</button>
            </div>
          </div>

          <!-- Tickets List -->
          <div class="tickets-list" id="ticketsList">
            <!-- Tickets serão carregados dinamicamente -->
          </div>

        </div>
      </section>

      <!-- New Ticket Modal -->
      <div class="modal" id="newTicketModal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Novo Ticket</h3>
            <button class="modal-close" onclick="closeNewTicketModal()" aria-label="Fechar modal">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <form class="ticket-form" id="newTicketForm">
            <div class="form-group">
              <label for="contrato">Contrato</label>
              <select id="contrato" name="contrato" required>
                <option value="">Selecione o contrato</option>
                <option value="ADM CAMP">ADM CAMP</option>
                <option value="ESUP">ESUP</option>
                <option value="FURP">FURP</option>
                <option value="METRÔ FIS">METRÔ FIS</option>
                <option value="METRÔ JABA">METRÔ JABA</option>
                <option value="P80">P80</option>
                <option value="REPLAN">REPLAN</option>
                <option value="REVAP">REVAP</option>
                <option value="TJSP">TJSP</option>
                <option value="TRANSP JURI">TRANSP JURI</option>
                <option value="TRANSP LOG">TRANSP LOG</option>
                <option value="UNESP INTERIOR">UNESP INTERIOR</option>
                <option value="ESCRITÓRIO CENTRAL">ESCRITÓRIO CENTRAL</option>
                <option value="REPLAN CAMPINAS">REPLAN CAMPINAS</option>
                <option value="P-80">P-80</option>
                <option value="METRÔ (ANÁLISE)">METRÔ (ANÁLISE)</option>
                <option value="TJ - MOTORISTAS">TJ - MOTORISTAS</option>
                <option value="METRÔ ECONÔMICO">METRÔ ECONÔMICO</option>
                <option value="ENGENHARIA SS">ENGENHARIA SS</option>
                <option value="TRANSPETRO LOGISTICA">TRANSPETRO LOGISTICA</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="gestor">Gestor Responsável</label>
              <select id="gestor" name="gestor_id">
                <option value="">Carregando gestores...</option>
              </select>
              <small class="helper-text">
                Serão exibidos apenas gestores do contrato selecionado
              </small>
            </div>
            
            <div class="form-group">
              <label for="setor">Setor de Destino</label>
              <select id="setor" name="setor" required>
                <option value="">Selecione o setor responsável</option>
                <option value="Departamento Pessoal">Departamento Pessoal</option>
                <option value="Facilities">Facilities</option>
                <option value="Recursos Humanos">Recursos Humanos</option>
                <option value="TI">TI - Tecnologia da Informação</option>
                <option value="Financeiro">Financeiro</option>
                <option value="Administrativo">Administrativo</option>
                <option value="Outros">Outros</option>
              </select>
            </div>

            <div class="form-group">
              <label for="categoria">Categoria</label>
              <select id="categoria" name="categoria" required>
                <option value="">Selecione uma categoria</option>
                <option value="ponto">Controle de Ponto</option>
                <option value="beneficios">Benefícios</option>
                <option value="ferias">Férias e Folgas</option>
                <option value="pagamento">Pagamento</option>
                <option value="documentos">Documentos</option>
                <option value="outros">Outros</option>
              </select>
            </div>

            <div class="form-group">
              <label for="prioridade">Prioridade</label>
              <select id="prioridade" name="prioridade" required>
                <option value="baixa">Baixa</option>
                <option value="media">Média</option>
                <option value="alta">Alta</option>
                <option value="urgente">Urgente</option>
              </select>
            </div>

            <div class="form-group">
              <label for="assunto">Assunto</label>
              <input type="text" id="assunto" name="assunto" placeholder="Descreva brevemente sua solicitação" maxlength="200" minlength="10" required>
            </div>

            <div class="form-group">
              <label for="descricao">Descrição Detalhada</label>
              <textarea id="descricao" name="descricao" rows="5" placeholder="Detalhe sua solicitação ou problema..." maxlength="1000" minlength="20" required></textarea>
            </div>

            <div class="form-actions">
              <button type="button" class="btn secondary" onclick="closeNewTicketModal()">Cancelar</button>
              <button type="submit" class="btn primary">Abrir Ticket</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Ticket Detail Modal -->
      <div class="modal" id="ticketDetailModal">
        <div class="modal-content large">
          <div class="modal-header">
            <h3 id="ticketDetailTitle">Detalhes do Ticket</h3>
            <button class="modal-close" onclick="closeTicketDetailModal()" aria-label="Fechar modal">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="ticket-detail-content" id="ticketDetailContent">
            <!-- Conteúdo será preenchido dinamicamente -->
          </div>
        </div>
      </div>

    </main>

    <footer class="site-footer">
      <div class="footer-top">
        <div class="container">
          <div class="footer-contact">
            <div class="contact-item">
              <i class="icon-email-green"></i>
              <span>contato@odequadroservicos.com.br</span>
            </div>
            <div class="footer-logo">
              <img src="Logo Grupo O. de Quadro.png" alt="O de Quadro" />
            </div>
            <div class="contact-item">
              <i class="icon-phone-green"></i>
              <span>+55 19 3278-2401</span>
              <div class="whatsapp-icon">
                <i class="icon-whatsapp"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="container">
          <p class="dev-credit">Desenvolvido por <strong>Bela Nascimento</strong></p>
        </div>
      </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
      // Sistema de Tickets - API Integration
      let currentUser = null;
      let authToken = null;
      let currentUserCPF = null;
      let currentUserRole = null;
      let resetUserData = null;
      const API_BASE = 'https://web-production-b4f40.up.railway.app/api';

      // Função para aplicar máscara de CPF
      function applyCPFMask(input) {
        let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
        
        if (value.length > 11) {
          value = value.slice(0, 11); // Limita a 11 dígitos
        }
        
        // Aplica a máscara
        if (value.length <= 3) {
          input.value = value;
        } else if (value.length <= 6) {
          input.value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
        } else if (value.length <= 9) {
          input.value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
        } else {
          input.value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
        }
      }

      // Função para contar caracteres em tempo real
      function addCharacterCounter(element, maxLength) {
        const counter = document.createElement('small');
        counter.className = 'char-counter';
        counter.style.cssText = 'color: #666; font-size: 12px; display: block; margin-top: 4px; text-align: right;';
        
        const updateCounter = () => {
          const remaining = maxLength - element.value.length;
          counter.textContent = `${element.value.length}/${maxLength}`;
          counter.style.color = remaining < 10 ? '#e74c3c' : '#666';
        };
        
        element.addEventListener('input', updateCounter);
        element.parentNode.appendChild(counter);
        updateCounter();
      }

      // Login functionality
      document.addEventListener('DOMContentLoaded', function() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const loginForm = document.getElementById('loginForm');

        // Aplicar máscaras e validações nos campos
        setupFieldValidations();

        function setupFieldValidations() {
          // Máscaras de CPF
          const cpfInputs = document.querySelectorAll('#cpf, #resetCPF, #primeiroCPF');
          cpfInputs.forEach(input => {
            input.addEventListener('input', function() {
              applyCPFMask(this);
            });
            
            // Remover caracteres não numéricos na validação
            input.addEventListener('blur', function() {
              const cleanValue = this.value.replace(/\D/g, '');
              if (cleanValue.length !== 11) {
                this.setCustomValidity('CPF deve ter 11 dígitos');
              } else {
                this.setCustomValidity('');
              }
            });
          });

          // Contadores de caracteres para campos de texto
          const assuntoInput = document.getElementById('assunto');
          const descricaoTextarea = document.getElementById('descricao');
          const nomeInput = document.getElementById('regNome');
          const primeiroNomeInput = document.getElementById('primeiroNome');
          
          if (assuntoInput) addCharacterCounter(assuntoInput, 200);
          if (descricaoTextarea) addCharacterCounter(descricaoTextarea, 1000);
          if (nomeInput) addCharacterCounter(nomeInput, 100);
          if (primeiroNomeInput) addCharacterCounter(primeiroNomeInput, 100);

          // Validação de senhas iguais no cadastro
          const regSenha = document.getElementById('regSenha');
          const regConfirmSenha = document.getElementById('regConfirmSenha');
          
          if (regConfirmSenha) {
            regConfirmSenha.addEventListener('input', function() {
              if (regSenha.value !== this.value) {
                this.setCustomValidity('As senhas não coincidem');
              } else {
                this.setCustomValidity('');
              }
            });
          }

          // Validação de senhas iguais no primeiro acesso
          const primeiroSenha = document.getElementById('primeiroSenha');
          const primeiroConfirmSenha = document.getElementById('primeiroConfirmSenha');
          
          if (primeiroConfirmSenha) {
            primeiroConfirmSenha.addEventListener('input', function() {
              if (primeiroSenha.value !== this.value) {
                this.setCustomValidity('As senhas não coincidem');
              } else {
                this.setCustomValidity('');
              }
            });
          }

          // Validação de senhas iguais no reset
          const newPassword = document.getElementById('newPassword');
          const confirmNewPassword = document.getElementById('confirmNewPassword');
          
          if (confirmNewPassword) {
            confirmNewPassword.addEventListener('input', function() {
              if (newPassword.value !== this.value) {
                this.setCustomValidity('As senhas não coincidem');
              } else {
                this.setCustomValidity('');
              }
            });
          }

          // Validação de email
          const emailInput = document.getElementById('regEmail');
          if (emailInput) {
            emailInput.addEventListener('blur', function() {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(this.value)) {
                this.setCustomValidity('Digite um email válido');
              } else {
                this.setCustomValidity('');
              }
            });
          }
        }

        // Tab switching
        tabBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Alternar entre formulários
            const selectedTab = this.dataset.tab;
            const loginForm = document.getElementById('loginForm');
            const primeiroAcessoForm = document.getElementById('primeiroAcessoForm');
            const helpLogin = document.querySelector('.help-login');
            const helpPrimeiroAcesso = document.querySelector('.help-primeiro-acesso');
            
            if (selectedTab === 'primeiro-acesso') {
              loginForm.classList.add('form-hidden');
              primeiroAcessoForm.classList.remove('form-hidden');
              helpLogin.classList.add('form-hidden');
              helpPrimeiroAcesso.classList.remove('form-hidden');
            } else {
              loginForm.classList.remove('form-hidden');
              primeiroAcessoForm.classList.add('form-hidden');
              helpLogin.classList.remove('form-hidden');
              helpPrimeiroAcesso.classList.add('form-hidden');
            }
          });
        });

        // Mostrar/ocultar campo de contratos baseado no tipo de usuário
        const primeiroTipo = document.getElementById('primeiroTipo');
        const contratosGroup = document.getElementById('contratosGroup');
        const primeiroContratos = document.getElementById('primeiroContratos');
        
        primeiroTipo.addEventListener('change', function() {
          if (this.value === 'gestor') {
            contratosGroup.style.display = 'block';
            primeiroContratos.required = true;
          } else {
            contratosGroup.style.display = 'none';
            primeiroContratos.required = false;
            // Limpar seleção
            Array.from(primeiroContratos.options).forEach(opt => opt.selected = false);
          }
        });

        // Login form
        loginForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const cpf = document.getElementById('cpf').value;
          const senha = document.getElementById('senha').value;
          const role = document.querySelector('.tab-btn.active').dataset.tab;

          try {
            const response = await fetch(`${API_BASE}/login`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ cpf, senha, role })
            });

            const data = await response.json();

            if (response.ok) {
              authToken = data.token;
              currentUser = data.user;
              currentUser.roleLabel = role === 'colaborador' ? 'Colaborador' : 
                                    role === 'gestor' ? 'Gestor' : 'Departamento Pessoal';
              
              localStorage.setItem('authToken', authToken);
              localStorage.setItem('currentUser', JSON.stringify(currentUser));

              showDashboard();
              loadTickets();
              loadDashboardStats();
            } else if (response.status === 401 && data.needsRegistration) {
              // Primeiro acesso - mostrar tela de cadastro
              currentUserCPF = cpf;
              currentUserRole = role;
              showRegisterSection();
            } else {
              alert(data.error || 'Erro no login');
            }
          } catch (error) {
            console.error('Login error:', error);
            alert('Erro de conexão');
          }
        });

        // Password reset form
        const resetForm = document.getElementById('resetForm');
        resetForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const formData = new FormData(this);
          const cpf = formData.get('cpf');
          const role = formData.get('role');

          try {
            const response = await fetch(`${API_BASE}/password-reset/verify`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ cpf, role })
            });

            const data = await response.json();

            if (response.ok) {
              resetUserData = data.user;
              showPasswordVerification();
            } else {
              alert(data.error || 'Usuário não encontrado');
            }
          } catch (error) {
            console.error('Reset verification error:', error);
            alert('Erro de conexão');
          }
        });

        // Password verification form
        const verificationForm = document.getElementById('verificationForm');
        verificationForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const formData = new FormData(this);
          const newPassword = formData.get('newPassword');
          const confirmNewPassword = formData.get('confirmNewPassword');
          
          if (newPassword !== confirmNewPassword) {
            alert('As senhas não coincidem');
            return;
          }
          
          if (newPassword.length < 6) {
            alert('A senha deve ter pelo menos 6 caracteres');
            return;
          }

          try {
            const response = await fetch(`${API_BASE}/password-reset/update`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ 
                cpf: resetUserData.cpf,
                role: resetUserData.role,
                newPassword: newPassword
              })
            });

            const data = await response.json();

            if (response.ok) {
              alert('Senha redefinida com sucesso! Agora você pode fazer login com a nova senha.');
              backToLogin();
            } else {
              alert(data.error || 'Erro ao redefinir senha');
            }
          } catch (error) {
            console.error('Password update error:', error);
            alert('Erro de conexão');
          }
        });

        // Primeiro acesso form
        const primeiroAcessoForm = document.getElementById('primeiroAcessoForm');
        primeiroAcessoForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const formData = new FormData(this);
          const cpf = formData.get('cpf').replace(/\D/g, '');
          const nome = formData.get('nome').trim();
          const email = formData.get('email').trim();
          const senha = formData.get('senha');
          const confirmSenha = formData.get('confirmSenha');
          const role = formData.get('role');
          const setor = formData.get('setor');
          
          // Validações
          if (!cpf || cpf.length !== 11) {
            alert('CPF deve ter 11 dígitos');
            return;
          }
          
          if (!nome || nome.length < 2) {
            alert('Nome deve ter pelo menos 2 caracteres');
            return;
          }
          
          if (!email || !email.includes('@')) {
            alert('Digite um e-mail válido');
            return;
          }
          
          if (!role) {
            alert('Selecione o tipo de usuário');
            return;
          }
          
          if (!setor) {
            alert('Selecione o setor');
            return;
          }
          
          if (senha !== confirmSenha) {
            alert('As senhas não coincidem');
            return;
          }
          
          if (senha.length < 6) {
            alert('A senha deve ter pelo menos 6 caracteres');
            return;
          }
          
          // Capturar contratos selecionados (se for gestor)
          let contratos = null;
          if (role === 'gestor') {
            const contratosSelect = document.getElementById('primeiroContratos');
            const selectedOptions = Array.from(contratosSelect.selectedOptions).map(opt => opt.value);
            
            if (selectedOptions.length === 0) {
              alert('Gestores devem selecionar pelo menos um contrato');
              return;
            }
            
            contratos = selectedOptions.join(',');
          }
          
          const userData = {
            cpf: formData.get('cpf').replace(/\D/g, ''), // Remove máscara do CPF
            nome: formData.get('nome').trim(),
            email: formData.get('email').trim(),
            senha: senha,
            role: formData.get('role'),
            setor: formData.get('setor'),
            contratos: contratos
          };

          try {
            const response = await fetch(`${API_BASE}/register`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(userData)
            });

            const data = await response.json();

            if (response.ok) {
              alert('Cadastro realizado com sucesso! Agora você pode fazer login.');
              // Limpar formulário e voltar para aba de login
              primeiroAcessoForm.reset();
              document.querySelector('[data-tab="colaborador"]').click();
            } else {
              alert(data.error || 'Erro no cadastro');
            }
          } catch (error) {
            console.error('Primeiro acesso error:', error);
            alert('Erro de conexão');
          }
        });

        // Register form
        const registerForm = document.getElementById('registerForm');
        registerForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const formData = new FormData(this);
          const senha = formData.get('senha');
          const confirmSenha = formData.get('confirmSenha');
          
          if (senha !== confirmSenha) {
            alert('As senhas não coincidem');
            return;
          }
          
          if (senha.length < 6) {
            alert('A senha deve ter pelo menos 6 caracteres');
            return;
          }
          
          const userData = {
            cpf: currentUserCPF,
            nome: formData.get('nome'),
            email: formData.get('email'),
            senha: senha,
            role: currentUserRole,
            setor: formData.get('setor')
          };

          try {
            const response = await fetch(`${API_BASE}/register`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(userData)
            });

            const data = await response.json();

            if (response.ok) {
              alert('Cadastro realizado com sucesso! Agora você pode fazer login.');
              document.getElementById('registerSection').classList.add('dashboard-hidden');
              document.getElementById('loginSection').classList.remove('dashboard-hidden');
              document.getElementById('loginForm').reset();
            } else {
              alert(data.error || 'Erro no cadastro');
            }
          } catch (error) {
            console.error('Register error:', error);
            alert('Erro de conexão');
          }
        });

        // Check for existing session
        const savedToken = localStorage.getItem('authToken');
        const savedUser = localStorage.getItem('currentUser');
        
        if (savedToken && savedUser) {
          authToken = savedToken;
          try {
            currentUser = JSON.parse(savedUser);
            showDashboard();
            loadTickets();
            loadDashboardStats();
          } catch (error) {
            console.error('Error parsing saved user data:', error);
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
          }
        }
        
        // Add connection test
        testConnection();
      });

      function showDashboard() {
        document.getElementById('loginSection').classList.add('dashboard-hidden');
        document.getElementById('dashboardSection').classList.remove('dashboard-hidden');
        
        document.getElementById('userName').textContent = currentUser.nome;
        document.getElementById('userRole').textContent = currentUser.roleLabel;
        
        // Configurar interface baseada no tipo de usuário
        setupUserInterface();
      }
      
      function setupUserInterface() {
        const userRole = currentUser.role;
        
        // Diferentes configurações para cada tipo de usuário
        if (userRole === 'colaborador') {
          // Colaborador vê apenas seus próprios tickets
          document.querySelector('.hero-breadcrumb span:last-child').textContent = 'Meus Tickets';
          document.querySelector('.page-hero h1').textContent = 'Meus Tickets';
          document.querySelector('.page-hero p').textContent = 'Acompanhe suas solicitações ao Departamento Pessoal';
        } else if (userRole === 'gestor') {
          // Gestor vê tickets do seu setor
          document.querySelector('.hero-breadcrumb span:last-child').textContent = 'Gestão de Tickets';
          document.querySelector('.page-hero h1').textContent = 'Gestão de Tickets';
          document.querySelector('.page-hero p').textContent = 'Gerencie tickets da sua equipe e departamento';
        } else if (userRole === 'dp') {
          // Departamento Pessoal vê todos os tickets
          document.querySelector('.hero-breadcrumb span:last-child').textContent = 'Administração de Tickets';
          document.querySelector('.page-hero h1').textContent = 'Administração de Tickets';
          document.querySelector('.page-hero p').textContent = 'Gerencie todas as solicitações da empresa';
        }
      }

      function showRegisterSection() {
        document.getElementById('loginSection').classList.add('dashboard-hidden');
        document.getElementById('registerSection').classList.remove('dashboard-hidden');
      }

      function showPasswordReset() {
        document.getElementById('loginSection').classList.add('dashboard-hidden');
        document.getElementById('resetSection').classList.remove('dashboard-hidden');
      }

      function showPasswordVerification() {
        document.getElementById('resetSection').classList.add('dashboard-hidden');
        document.getElementById('resetVerificationSection').classList.remove('dashboard-hidden');
        
        // Mostrar dados do usuário para confirmação
        const verificationInfo = document.getElementById('verificationInfo');
        verificationInfo.innerHTML = `
          <div class="user-verification">
            <h4>Confirme seus dados:</h4>
            <p><strong>Nome:</strong> ${resetUserData.nome}</p>
            <p><strong>Email:</strong> ${resetUserData.email}</p>
            <p><strong>Setor:</strong> ${resetUserData.setor || 'Não informado'}</p>
            <p class="verification-note">Se estes dados estão corretos, você pode redefinir sua senha abaixo.</p>
          </div>
        `;
      }

      function backToLogin() {
        // Limpar formulários
        document.getElementById('resetForm').reset();
        document.getElementById('verificationForm').reset();
        
        // Esconder todas as seções e mostrar login
        document.getElementById('resetSection').classList.add('dashboard-hidden');
        document.getElementById('resetVerificationSection').classList.add('dashboard-hidden');
        document.getElementById('registerSection').classList.add('dashboard-hidden');
        document.getElementById('loginSection').classList.remove('dashboard-hidden');
        
        resetUserData = null;
      }

      function logout() {
        currentUser = null;
        authToken = null;
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        
        document.getElementById('loginSection').classList.remove('dashboard-hidden');
        document.getElementById('dashboardSection').classList.add('dashboard-hidden');
        document.getElementById('loginForm').reset();
      }

      async function loadTickets(status = null) {
        try {
          let url = `${API_BASE}/tickets`;
          if (status) {
            url += `?status=${status}`;
          }

          const response = await fetch(url, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            const tickets = await response.json();
            displayTickets(tickets);
          } else {
            console.error('Error loading tickets');
          }
        } catch (error) {
          console.error('Load tickets error:', error);
        }
      }

      function displayTickets(tickets) {
        const ticketsList = document.getElementById('ticketsList');
        ticketsList.innerHTML = '';

        if (tickets.length === 0) {
          ticketsList.innerHTML = '<div class="no-tickets">Nenhum ticket encontrado</div>';
          return;
        }

        tickets.forEach(ticket => {
          const ticketElement = createTicketElement(ticket);
          ticketsList.appendChild(ticketElement);
        });
      }

      async function loadDashboardStats() {
        try {
          const response = await fetch(`${API_BASE}/dashboard/stats`, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            const stats = await response.json();
            updateStatsDisplay(stats);
          }
        } catch (error) {
          console.error('Load stats error:', error);
        }
      }

      function updateStatsDisplay(stats) {
        document.getElementById('statsAbertos').textContent = stats.abertos || 0;
        document.getElementById('statsAndamento').textContent = stats.andamento || 0;
        document.getElementById('statsResolvidos').textContent = stats.resolvidos || 0;
        document.getElementById('statsTotal').textContent = stats.total || 0;
        
        // Show export button for gestors and dp
        if (currentUser.role === 'gestor' || currentUser.role === 'dp') {
          document.getElementById('exportBtn').classList.remove('export-hidden');
        }
      }

      function createTicketElement(ticket) {
        const div = document.createElement('div');
        div.className = `ticket-item ${ticket.status}`;
        
        const statusBadge = getStatusBadge(ticket.status);
        const priorityBadge = getPriorityBadge(ticket.prioridade);

        div.innerHTML = `
          <div class="ticket-header">
            <div class="ticket-id">#${ticket.numero || ticket.id}</div>
            <div class="ticket-badges">
              ${statusBadge}
              ${priorityBadge}
            </div>
          </div>
          <div class="ticket-content">
            <h4>${ticket.assunto}</h4>
            <p class="ticket-description-preview">${ticket.descricao ? ticket.descricao.substring(0, 120) + (ticket.descricao.length > 120 ? '...' : '') : ''}</p>
            <div class="ticket-meta">
              <span><i class="fas fa-user"></i> ${ticket.solicitante_nome || ticket.solicitante}</span>
              <span><i class="fas fa-calendar"></i> ${formatDate(ticket.created_at || ticket.data)}</span>
              <span><i class="fas fa-tag"></i> ${getCategoryLabel(ticket.categoria)}</span>
              ${ticket.setor ? `<span><i class="fas fa-building"></i> ${ticket.setor}</span>` : ''}
              ${ticket.assigned_nome ? `<span><i class="fas fa-user-check"></i> ${ticket.assigned_nome}</span>` : ''}
            </div>
          </div>
          <div class="ticket-actions">
            <button class="btn small primary" onclick="viewTicket(${ticket.id})">
              <i class="fas fa-eye"></i> Ver Detalhes
            </button>
            ${(currentUser.role === 'dp' || currentUser.role === 'gestor') && ticket.status !== 'resolvido' ? `
              <button class="btn small secondary" onclick="updateTicketStatus(${ticket.id})">
                <i class="fas fa-edit"></i> Atualizar
              </button>
            ` : ''}
          </div>
        `;

        return div;
      }

      function getStatusBadge(status) {
        const badges = {
          'aberto': '<span class="status-badge aberto">Aberto</span>',
          'em-andamento': '<span class="status-badge em-andamento">Em Andamento</span>',
          'resolvido': '<span class="status-badge resolvido">Resolvido</span>'
        };
        return badges[status] || '';
      }

      function getPriorityBadge(priority) {
        const badges = {
          'baixa': '<span class="priority-badge baixa">Baixa</span>',
          'media': '<span class="priority-badge media">Média</span>',
          'alta': '<span class="priority-badge alta">Alta</span>',
          'urgente': '<span class="priority-badge urgente">Urgente</span>'
        };
        return badges[priority] || '';
      }

      function getCategoryLabel(category) {
        const labels = {
          'ponto': 'Controle de Ponto',
          'beneficios': 'Benefícios',
          'ferias': 'Férias e Folgas',
          'pagamento': 'Pagamento',
          'documentos': 'Documentos',
          'outros': 'Outros'
        };
        return labels[category] || category;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
      }

      function openNewTicketModal() {
        document.getElementById('newTicketModal').classList.add('modal-active');
      }

      function closeNewTicketModal() {
        document.getElementById('newTicketModal').classList.remove('modal-active');
        document.getElementById('newTicketForm').reset();
      }

      async function viewTicket(ticketId) {
        try {
          const response = await fetch(`${API_BASE}/tickets/${ticketId}`, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            const ticket = await response.json();
            
            document.getElementById('ticketDetailTitle').textContent = `Ticket #${ticket.numero}`;
            
            const content = `
              <div class="ticket-detail-info">
                <div class="detail-row">
                  <strong>Assunto:</strong> ${ticket.assunto}
                </div>
                <div class="detail-row">
                  <strong>Categoria:</strong> ${getCategoryLabel(ticket.categoria)}
                </div>
                <div class="detail-row">
                  <strong>Prioridade:</strong> ${ticket.prioridade}
                </div>
                <div class="detail-row">
                  <strong>Status:</strong> ${ticket.status}
                </div>
                <div class="detail-row">
                  <strong>Data:</strong> ${formatDate(ticket.created_at)}
                </div>
                <div class="detail-row">
                  <strong>Solicitante:</strong> ${ticket.solicitante_nome}
                </div>
                ${ticket.setor ? `
                  <div class="detail-row">
                    <strong>Setor:</strong> ${ticket.setor}
                  </div>
                ` : ''}
                ${ticket.assigned_nome ? `
                  <div class="detail-row">
                    <strong>Responsável:</strong> ${ticket.assigned_nome}
                  </div>
                ` : ''}
              </div>
              <div class="ticket-description">
                <strong>Descrição:</strong>
                <p>${ticket.descricao}</p>
              </div>
              ${ticket.resposta ? `
                <div class="ticket-response">
                  <strong>Resposta do Departamento:</strong>
                  <p>${ticket.resposta}</p>
                </div>
              ` : ''}
              ${(currentUserRole === 'dp' || currentUserRole === 'gestor') && !ticket.resposta ? `
                <div class="ticket-response-form">
                  <strong>Adicionar Resposta:</strong>
                  <textarea id="respostaTexto" placeholder="Digite a resposta oficial para este ticket..." maxlength="1000" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; margin-top: 10px;"></textarea>
                  <button onclick="addResposta(${ticket.id})" class="btn-primary" style="margin-top: 10px;">
                    <i class="fas fa-reply"></i> Enviar Resposta
                  </button>
                </div>
              ` : ''}
              ${ticket.comments && ticket.comments.length > 0 ? `
                <div class="ticket-comments">
                  <strong>Comentários:</strong>
                  ${ticket.comments.map(comment => `
                    <div class="comment">
                      <div class="comment-header">
                        <strong>${comment.autor_nome}</strong>
                        <small>${formatDate(comment.created_at)}</small>
                      </div>
                      <p>${comment.comentario}</p>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            `;
            
            document.getElementById('ticketDetailContent').innerHTML = content;
            document.getElementById('ticketDetailModal').classList.add('modal-active');
          } else {
            alert('Erro ao carregar detalhes do ticket');
          }
        } catch (error) {
          console.error('View ticket error:', error);
          alert('Erro de conexão');
        }
      }

      function closeTicketDetailModal() {
        document.getElementById('ticketDetailModal').classList.remove('modal-active');
      }

      // Adicionar resposta ao ticket (DP/Gestor)
      async function addResposta(ticketId) {
        const respostaTexto = document.getElementById('respostaTexto').value.trim();
        
        if (!respostaTexto) {
          alert('Por favor, digite uma resposta');
          return;
        }
        
        if (respostaTexto.length < 10) {
          alert('A resposta deve ter pelo menos 10 caracteres');
          return;
        }
        
        try {
          const response = await fetch(`${API_BASE}/tickets/${ticketId}/resposta`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ resposta: respostaTexto })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            alert('Resposta adicionada com sucesso!');
            closeTicketDetailModal();
            loadTickets();
            loadDashboardStats();
          } else {
            alert(data.error || 'Erro ao adicionar resposta');
          }
        } catch (error) {
          console.error('Add resposta error:', error);
          alert('Erro de conexão');
        }
      }

      function refreshTickets() {
        loadTickets();
        loadDashboardStats();
      }

      // New ticket form submission
      document.getElementById('newTicketForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const ticketData = {
          contrato: formData.get('contrato'),
          setor: formData.get('setor'),
          categoria: formData.get('categoria'),
          prioridade: formData.get('prioridade'),
          assunto: formData.get('assunto'),
          descricao: formData.get('descricao'),
          gestor_id: formData.get('gestor_id') || null
        };

        try {
          const response = await fetch(`${API_BASE}/tickets`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(ticketData)
          });

          const data = await response.json();

          if (response.ok) {
            closeNewTicketModal();
            loadTickets();
            alert(`Ticket #${data.ticket.numero} criado com sucesso!`);
          } else {
            alert(data.error || 'Erro ao criar ticket');
          }
        } catch (error) {
          console.error('Create ticket error:', error);
          alert('Erro de conexão');
        }
      });

      // Carregar gestores baseado no contrato selecionado
      const contratoSelect = document.getElementById('contrato');
      const gestorSelect = document.getElementById('gestor');
      
      contratoSelect.addEventListener('change', async function() {
        const contrato = this.value;
        
        if (!contrato) {
          gestorSelect.innerHTML = '<option value="">Primeiro selecione um contrato</option>';
          return;
        }
        
        try {
          gestorSelect.innerHTML = '<option value="">Carregando...</option>';
          
          const response = await fetch(`${API_BASE}/gestores-por-contrato?contrato=${encodeURIComponent(contrato)}`, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });
          
          const data = await response.json();
          
          if (response.ok && data.gestores && data.gestores.length > 0) {
            gestorSelect.innerHTML = '<option value="">Selecione um gestor (opcional)</option>';
            data.gestores.forEach(gestor => {
              const option = document.createElement('option');
              option.value = gestor.id;
              option.textContent = `${gestor.nome} - ${gestor.setor}`;
              gestorSelect.appendChild(option);
            });
          } else {
            gestorSelect.innerHTML = '<option value="">Nenhum gestor disponível para este contrato</option>';
          }
        } catch (error) {
          console.error('Erro ao carregar gestores:', error);
          gestorSelect.innerHTML = '<option value="">Erro ao carregar gestores</option>';
        }
      });

      // Filter functionality
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('filter-btn')) {
          document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
          e.target.classList.add('active');
          
          const filter = e.target.dataset.filter;
          filterTickets(filter);
        }
      });

      function filterTickets(filter) {
        if (filter === 'all') {
          loadTickets();
        } else {
          loadTickets(filter);
        }
      }
      
      async function exportTickets() {
        try {
          const response = await fetch(`${API_BASE}/tickets/export`, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });
          
          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.classList.add('download-link-hidden');
            a.href = url;
            a.download = `tickets-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } else {
            alert('Erro ao exportar tickets');
          }
        } catch (error) {
          console.error('Export error:', error);
          alert('Erro de conexão');
        }
      }
      
      async function updateTicketStatus(ticketId) {
        const newStatus = prompt('Novo status (aberto, em-andamento, resolvido):');
        if (!newStatus || !['aberto', 'em-andamento', 'resolvido'].includes(newStatus)) {
          alert('Status inválido');
          return;
        }
        
        try {
          const response = await fetch(`${API_BASE}/tickets/${ticketId}/status`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ status: newStatus })
          });
          
          if (response.ok) {
            loadTickets();
            loadDashboardStats();
            alert('Status atualizado com sucesso!');
          } else {
            alert('Erro ao atualizar status');
          }
        } catch (error) {
          console.error('Update status error:', error);
          alert('Erro de conexão');
        }
      }
      
      // Test API connection
      async function testConnection() {
        try {
          const response = await fetch(`${API_BASE}/test`, {
            method: 'GET'
          });
          
          if (!response.ok) {
            console.log('API connection test failed');
          } else {
            console.log('API connection OK');
          }
        } catch (error) {
          console.error('API connection error:', error);
        }
      }
    </script>
  </body>
</html>